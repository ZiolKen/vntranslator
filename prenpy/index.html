<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ren'Py Translator Workbench</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1621; --panel2:#0c121b; --line:#1d2a3a;
      --text:#e6edf7; --muted:#95a4b8; --accent:#7c5cff; --good:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --shadow: 0 10px 35px rgba(0,0,0,.45);
      --r:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,.25), transparent 55%) , var(--bg); color:var(--text); font-family:var(--sans)}
    button,input,select,textarea{font:inherit;color:inherit}
    a{color:inherit}
    .app{height:100%; display:grid; grid-template-rows:56px 1fr 34px; gap:10px; padding:10px}
    .topbar{
      display:flex; align-items:center; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line); border-radius:var(--r); padding:10px 12px; box-shadow:var(--shadow)
    }
    .brand{display:flex; align-items:center; gap:10px; padding-right:10px; border-right:1px solid var(--line)}
    .logo{width:30px;height:30px;border-radius:10px;background:
      radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
      linear-gradient(135deg, rgba(124,92,255,.95), rgba(45,212,191,.9));
      box-shadow:0 10px 25px rgba(124,92,255,.25)
    }
    .brand h1{font-size:14px;margin:0;letter-spacing:.4px}
    .pill{display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03)}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.03); cursor:pointer; transition:.15s transform,.15s background,.15s border-color
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.06); border-color:rgba(124,92,255,.55)}
    .btn.primary{background:rgba(124,92,255,.18); border-color:rgba(124,92,255,.5)}
    .btn.danger{background:rgba(251,113,133,.12); border-color:rgba(251,113,133,.35)}
    .btn.good{background:rgba(45,212,191,.10); border-color:rgba(45,212,191,.35)}
    .spacer{flex:1}
    .field{display:flex; gap:8px; align-items:center}
    .input{
      background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:12px;
      padding:8px 10px; outline:none; min-width:220px
    }
    .input:focus{border-color:rgba(124,92,255,.6); box-shadow:0 0 0 3px rgba(124,92,255,.18)}
    .select{
      background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:12px;
      padding:8px 10px; outline:none
    }
    .main{display:grid; grid-template-columns:300px 1fr 360px; gap:10px; min-height:0}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); min-height:0; overflow:hidden
    }
    .panelHeader{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-bottom:1px solid var(--line); background:rgba(255,255,255,.02)
    }
    .panelHeader h2{margin:0; font-size:12px; letter-spacing:.5px; text-transform:uppercase; color:var(--muted)}
    .panelBody{height:100%; min-height:0}
    .left{display:grid; grid-template-rows:auto 1fr auto}
    .treeControls{display:flex; gap:8px; align-items:center; width:100%}
    .tree{padding:6px; overflow:auto; height:100%}
    .treeItem{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:12px; cursor:pointer; border:1px solid transparent;
      color:var(--text)
    }
    .treeItem:hover{background:rgba(255,255,255,.04)}
    .treeItem.active{background:rgba(124,92,255,.12); border-color:rgba(124,92,255,.35)}
    .badge{margin-left:auto; font-size:12px; color:var(--muted)}
    .percent{
      font-size:12px; padding:2px 8px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--muted)
    }
    .leftFooter{padding:10px 12px;border-top:1px solid var(--line);display:flex;gap:8px;align-items:center}
    .center{display:grid; grid-template-rows:auto 1fr}
    .gridControls{display:flex; gap:8px; align-items:center; width:100%}
    .tabs{display:flex; gap:6px; align-items:center}
    .tab{
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.02); cursor:pointer; font-size:12px; color:var(--muted)
    }
    .tab.active{background:rgba(124,92,255,.14); border-color:rgba(124,92,255,.45); color:var(--text)}
    .tableWrap{overflow:auto; height:100%}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:980px}
    thead th{
      position:sticky; top:0; z-index:2;
      background:rgba(10,14,20,.92); backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line); padding:10px; text-align:left; font-size:12px; color:var(--muted)
    }
    tbody td{
      border-bottom:1px solid rgba(29,42,58,.65);
      padding:10px; vertical-align:top
    }
    tbody tr:hover td{background:rgba(255,255,255,.02)}
    tbody tr.selected td{background:rgba(124,92,255,.10)}
    .colCheck{width:38px}
    .colId{width:120px; font-family:var(--mono); color:var(--muted); font-size:12px}
    .cellText{white-space:pre-wrap; line-height:1.35}
    .cellMeta{display:flex; gap:8px; align-items:center; margin-top:6px; color:var(--muted); font-size:12px}
    .tag{
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.02); color:var(--muted)
    }
    .edit{
      width:100%; min-height:56px; resize:vertical;
      background:rgba(255,255,255,.02); border:1px solid var(--line);
      border-radius:12px; padding:10px; outline:none
    }
    .edit:focus{border-color:rgba(124,92,255,.6); box-shadow:0 0 0 3px rgba(124,92,255,.16)}
    .right{display:grid; grid-template-rows:auto 1fr}
    .rightBody{display:grid; grid-template-rows:1fr 1fr 1fr; gap:10px; padding:10px; overflow:auto; height:100%}
    .card{
      border:1px solid var(--line); border-radius:var(--r);
      background:rgba(255,255,255,.02); overflow:hidden; min-height:0
    }
    .cardHeader{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--line);color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.4px}
    .cardBody{padding:10px 12px; overflow:auto; height:100%}
    .kv{display:grid; grid-template-columns:110px 1fr; gap:8px; font-size:13px; color:var(--text)}
    .kv div:nth-child(odd){color:var(--muted)}
    .mono{font-family:var(--mono)}
    .statusbar{
      display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,.03); border:1px solid var(--line);
      border-radius:var(--r); padding:8px 12px
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good);box-shadow:0 0 0 3px rgba(45,212,191,.12)}
    .statusText{color:var(--muted); font-size:12px}
    .kbd{font-family:var(--mono); font-size:11px; padding:2px 6px; border:1px solid var(--line); border-radius:8px; background:rgba(255,255,255,.02); color:var(--muted)}
    .modalOverlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px}
    .modalOverlay.show{display:flex}
    .modal{
      width:min(860px, 100%); max-height:min(80vh, 860px); overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(124,92,255,.35); border-radius:18px; box-shadow:var(--shadow)
    }
    .modalHeader{display:flex; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid var(--line)}
    .modalHeader h3{margin:0; font-size:13px; letter-spacing:.4px}
    .modalBody{padding:12px 14px; overflow:auto; max-height:calc(80vh - 120px)}
    .modalFooter{display:flex; justify-content:flex-end; gap:8px; padding:12px 14px; border-top:1px solid var(--line)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .small{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:10px 0}
  </style>
</head>
<body>
  <div id="app" class="app">
    <div id="topbar" class="topbar">
      <div class="brand" id="brand">
        <div class="logo" id="logo"></div>
        <div>
          <h1 id="appTitle">Ren'Py Translator Workbench</h1>
          <div id="projectMeta" class="small">Project: <span id="projectName">Untitled</span> ‚Ä¢ Lang: <span id="projectLang">en</span></div>
        </div>
      </div>

      <button id="btnOpen" class="btn primary" type="button">Open</button>
      <button id="btnSave" class="btn good" type="button">Save</button>
      <button id="btnExport" class="btn" type="button">Export</button>
      <button id="btnImport" class="btn" type="button">Import</button>
      <button id="btnUndo" class="btn" type="button">Undo</button>
      <button id="btnRedo" class="btn" type="button">Redo</button>

      <div class="pill" id="pillMode">
        <span class="small">Mode</span>
        <select id="selectMode" class="select">
          <option value="translate" selected>Translate</option>
          <option value="review">Review</option>
          <option value="qa">QA</option>
        </select>
      </div>

      <div class="spacer"></div>

      <div class="field" id="fieldSearch">
        <input id="inputQuickSearch" class="input" placeholder="Search (Ctrl+F)" />
        <button id="btnFindReplace" class="btn" type="button">Find/Replace</button>
      </div>

      <button id="btnSettings" class="btn" type="button">Settings</button>
    </div>

    <div id="main" class="main">
      <div id="panelLeft" class="panel left">
        <div class="panelHeader" id="leftHeader">
          <h2 id="leftTitle">Files</h2>
          <div class="treeControls" id="treeControls">
            <input id="inputFileFilter" class="input" placeholder="Filter files‚Ä¶" style="min-width:0;flex:1" />
          </div>
        </div>
        <div id="fileTree" class="tree panelBody" role="tree"></div>
        <div id="leftFooter" class="leftFooter">
          <span id="statFiles" class="percent">0 files</span>
          <span id="statRows" class="percent">0 rows</span>
          <span id="statProgress" class="percent">0% done</span>
        </div>
      </div>

      <div id="panelCenter" class="panel center">
        <div class="panelHeader" id="centerHeader">
          <h2 id="centerTitle">Strings</h2>
          <div class="gridControls" id="gridControls">
            <div class="tabs" id="tabs">
              <div class="tab active" id="tabAll" data-tab="all">All</div>
              <div class="tab" id="tabUntranslated" data-tab="untranslated">Untranslated</div>
              <div class="tab" id="tabTranslated" data-tab="translated">Translated</div>
              <div class="tab" id="tabFlagged" data-tab="flagged">Flagged</div>
            </div>
            <div class="spacer"></div>
            <button id="btnFlag" class="btn" type="button">Flag</button>
            <button id="btnCopySource" class="btn" type="button">Copy Source</button>
            <button id="btnApplyTM" class="btn" type="button">Apply TM</button>
          </div>
        </div>

        <div id="tableWrap" class="tableWrap panelBody">
          <table id="stringsTable">
            <thead id="stringsThead">
              <tr>
                <th id="thCheck" class="colCheck"><input id="checkAll" type="checkbox" /></th>
                <th id="thId" class="colId">Key</th>
                <th id="thSpeaker" style="width:140px">Speaker</th>
                <th id="thSource">Source</th>
                <th id="thTarget">Translation</th>
              </tr>
            </thead>
            <tbody id="stringsTbody"></tbody>
          </table>
        </div>
      </div>

      <div id="panelRight" class="panel right">
        <div class="panelHeader" id="rightHeader">
          <h2 id="rightTitle">Inspector</h2>
          <div class="spacer"></div>
          <button id="btnAddToGlossary" class="btn" type="button">Add to Glossary</button>
        </div>

        <div id="rightBody" class="rightBody panelBody">
          <div id="cardContext" class="card">
            <div id="cardContextHeader" class="cardHeader">Context</div>
            <div id="cardContextBody" class="cardBody">
              <div class="kv" id="contextKv">
                <div>File</div><div id="ctxFile" class="mono">‚Äî</div>
                <div>Line</div><div id="ctxLine" class="mono">‚Äî</div>
                <div>Label</div><div id="ctxLabel" class="mono">‚Äî</div>
                <div>Tags</div><div id="ctxTags">‚Äî</div>
              </div>
            </div>
          </div>

          <div id="cardTM" class="card">
            <div id="cardTMHeader" class="cardHeader">Translation Memory</div>
            <div id="cardTMBody" class="cardBody">
              <div class="small" id="tmHint">Select a row, then click ‚ÄúApply TM‚Äù. TM is stored locally (IndexedDB).</div>
              <div class="hr"></div>
              <div id="tmMatches" class="small">No matches.</div>
            </div>
          </div>

          <div id="cardPreview" class="card">
            <div id="cardPreviewHeader" class="cardHeader">Preview</div>
            <div id="cardPreviewBody" class="cardBody">
              <div class="small" id="previewHint">UI preview only. Game rendering/hooking comes later.</div>
              <div class="hr"></div>
              <div id="previewBox" style="border:1px solid var(--line); border-radius:14px; padding:12px; background:rgba(0,0,0,.25)">
                <div id="previewSpeaker" class="mono" style="color:var(--muted); margin-bottom:8px">‚Äî</div>
                <div id="previewText" style="white-space:pre-wrap; line-height:1.35">Select a string to preview.</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div id="statusbar" class="statusbar">
      <div id="statusDot" class="dot"></div>
      <div id="statusText" class="statusText">Ready.</div>
      <div class="spacer"></div>
      <span class="kbd" id="kbdSave">Ctrl+S</span>
      <span class="kbd" id="kbdFind">Ctrl+F</span>
      <span class="kbd" id="kbdFlag">F</span>
      <span class="kbd" id="kbdApplyTm">T</span>
    </div>
  </div>

  <input id="filePicker" type="file" accept=".json" style="display:none" />
  <input id="importPicker" type="file" accept=".json,.csv" style="display:none" />

  <div id="modalOverlay" class="modalOverlay" aria-hidden="true">
    <div id="modal" class="modal" role="dialog" aria-modal="true">
      <div id="modalHeader" class="modalHeader">
        <h3 id="modalTitle">Find & Replace</h3>
        <div class="spacer"></div>
        <button id="btnModalClose" class="btn danger" type="button">Close</button>
      </div>
      <div id="modalBody" class="modalBody"></div>
      <div id="modalFooter" class="modalFooter"></div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const state = {
    project: {
      name: "Untitled",
      lang: "en",
      files: [],
      rows: [],
    },
    view: {
      activeFileId: null,
      tab: "all",
      quickSearch: "",
      selectedRowIds: new Set(),
      focusedRowId: null,
    },
    history: { undo: [], redo: [] },
    tm: { db: null, lastMatches: [] },
    glossary: {},
  };

  const ids = {
    app: $("app"),
    fileTree: $("fileTree"),
    stringsTbody: $("stringsTbody"),
    projectName: $("projectName"),
    projectLang: $("projectLang"),
    statFiles: $("statFiles"),
    statRows: $("statRows"),
    statProgress: $("statProgress"),
    statusText: $("statusText"),
    inputFileFilter: $("inputFileFilter"),
    inputQuickSearch: $("inputQuickSearch"),
    checkAll: $("checkAll"),
    filePicker: $("filePicker"),
    importPicker: $("importPicker"),
    modalOverlay: $("modalOverlay"),
    modalBody: $("modalBody"),
    modalFooter: $("modalFooter"),
    modalTitle: $("modalTitle"),

    ctxFile: $("ctxFile"),
    ctxLine: $("ctxLine"),
    ctxLabel: $("ctxLabel"),
    ctxTags: $("ctxTags"),
    tmMatches: $("tmMatches"),
    previewSpeaker: $("previewSpeaker"),
    previewText: $("previewText"),
  };

  const setStatus = (t) => { ids.statusText.textContent = t; };

  const nowId = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  const deepClone = (x) => JSON.parse(JSON.stringify(x));
  const snapshot = () => deepClone({ project: state.project, view: { ...state.view, selectedRowIds: Array.from(state.view.selectedRowIds) }});
  const restore = (snap) => {
    state.project = snap.project;
    state.view = snap.view;
    state.view.selectedRowIds = new Set(snap.view.selectedRowIds || []);
  };

  const pushHistory = () => {
    state.history.undo.push(snapshot());
    state.history.redo.length = 0;
    if (state.history.undo.length > 80) state.history.undo.shift();
  };

  const undo = () => {
    if (!state.history.undo.length) return;
    state.history.redo.push(snapshot());
    restore(state.history.undo.pop());
    renderAll();
    setStatus("Undone.");
  };

  const redo = () => {
    if (!state.history.redo.length) return;
    state.history.undo.push(snapshot());
    restore(state.history.redo.pop());
    renderAll();
    setStatus("Redone.");
  };

  const persist = () => {
    localStorage.setItem("rpw_project", JSON.stringify(state.project));
    localStorage.setItem("rpw_view", JSON.stringify({ ...state.view, selectedRowIds: Array.from(state.view.selectedRowIds) }));
    localStorage.setItem("rpw_glossary", JSON.stringify(state.glossary));
  };

  const loadPersisted = () => {
    const p = localStorage.getItem("rpw_project");
    const v = localStorage.getItem("rpw_view");
    const g = localStorage.getItem("rpw_glossary");
    if (p) state.project = JSON.parse(p);
    if (v) {
      const vv = JSON.parse(v);
      state.view = { ...state.view, ...vv, selectedRowIds: new Set(vv.selectedRowIds || []) };
    }
    if (g) state.glossary = JSON.parse(g);
  };

  const download = (name, text, mime="application/json") => {
    const blob = new Blob([text], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };

  const normalize = (s) => (s ?? "").toString();
  const includesCI = (a,b) => normalize(a).toLowerCase().includes(normalize(b).toLowerCase());

  const progressPct = () => {
    const rows = state.project.rows || [];
    if (!rows.length) return 0;
    const done = rows.filter(r => normalize(r.target).trim().length > 0).length;
    return Math.round((done / rows.length) * 100);
  };

  const openModal = (title, bodyEl, footerEl) => {
    ids.modalTitle.textContent = title;
    ids.modalBody.innerHTML = "";
    ids.modalFooter.innerHTML = "";
    ids.modalBody.appendChild(bodyEl);
    ids.modalFooter.appendChild(footerEl);
    ids.modalOverlay.classList.add("show");
    ids.modalOverlay.setAttribute("aria-hidden","false");
  };

  const closeModal = () => {
    ids.modalOverlay.classList.remove("show");
    ids.modalOverlay.setAttribute("aria-hidden","true");
  };

  const initTM = async () => {
    state.tm.db = await new Promise((resolve, reject) => {
      const req = indexedDB.open("rpw_tm", 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        const store = db.createObjectStore("tm", { keyPath: "k" });
        store.createIndex("src", "src", { unique: false });
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  };

  const tmPut = async (src, tgt, meta={}) => {
    if (!state.tm.db) return;
    const k = (src||"").trim();
    const v = (tgt||"").trim();
    if (!k || !v) return;
    await new Promise((resolve, reject) => {
      const tx = state.tm.db.transaction("tm", "readwrite");
      tx.objectStore("tm").put({ k, src: k, tgt: v, meta, ts: Date.now() });
      tx.oncomplete = resolve;
      tx.onerror = () => reject(tx.error);
    });
  };

  const tmFind = async (src) => {
    if (!state.tm.db) return [];
    const key = (src||"").trim();
    if (!key) return [];
    return await new Promise((resolve, reject) => {
      const tx = state.tm.db.transaction("tm", "readonly");
      const req = tx.objectStore("tm").get(key);
      req.onsuccess = () => resolve(req.result ? [req.result] : []);
      req.onerror = () => reject(req.error);
    });
  };

  const getFilteredRows = () => {
    const { activeFileId, tab, quickSearch } = state.view;
    const fileOk = (r) => !activeFileId || r.fileId === activeFileId;
    const tabOk = (r) => {
      const has = normalize(r.target).trim().length > 0;
      if (tab === "untranslated") return !has;
      if (tab === "translated") return has;
      if (tab === "flagged") return !!r.flagged;
      return true;
    };
    const searchOk = (r) => {
      if (!quickSearch.trim()) return true;
      return (
        includesCI(r.key, quickSearch) ||
        includesCI(r.speaker, quickSearch) ||
        includesCI(r.source, quickSearch) ||
        includesCI(r.target, quickSearch) ||
        includesCI((r.tags||[]).join(" "), quickSearch) ||
        includesCI(r.label, quickSearch)
      );
    };
    return (state.project.rows || []).filter(r => fileOk(r) && tabOk(r) && searchOk(r));
  };

  const renderTree = () => {
    const q = normalize(ids.inputFileFilter.value).trim().toLowerCase();
    const files = (state.project.files || []).filter(f => !q || normalize(f.name).toLowerCase().includes(q));
    ids.fileTree.innerHTML = "";
    files.forEach(f => {
      const rows = (state.project.rows||[]).filter(r => r.fileId === f.id);
      const done = rows.filter(r => normalize(r.target).trim().length > 0).length;
      const pct = rows.length ? Math.round((done/rows.length)*100) : 0;

      const el = document.createElement("div");
      el.id = `file_${f.id}`;
      el.className = "treeItem" + (state.view.activeFileId === f.id ? " active" : "");
      el.setAttribute("role","treeitem");
      el.innerHTML = `
        <span class="mono">üìÑ</span>
        <span>${escapeHtml(f.name)}</span>
        <span class="badge">${rows.length} strings</span>
        <span class="percent">${pct}%</span>
      `;
      el.onclick = () => {
        pushHistory();
        state.view.activeFileId = f.id;
        state.view.selectedRowIds.clear();
        state.view.focusedRowId = null;
        renderAll();
        setStatus(`File: ${f.name}`);
      };
      ids.fileTree.appendChild(el);
    });
  };

  const renderTable = () => {
    const rows = getFilteredRows();
    ids.stringsTbody.innerHTML = "";
    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.id = `row_${r.id}`;
      tr.className = state.view.selectedRowIds.has(r.id) ? "selected" : "";
      tr.innerHTML = `
        <td class="colCheck"><input id="chk_${r.id}" type="checkbox" ${state.view.selectedRowIds.has(r.id) ? "checked":""} /></td>
        <td class="colId">${escapeHtml(r.key || r.id)}</td>
        <td><div class="cellText">${escapeHtml(r.speaker||"")}</div></td>
        <td>
          <div class="cellText" id="src_${r.id}">${escapeHtml(r.source||"")}</div>
          <div class="cellMeta">
            ${r.flagged ? `<span class="tag" style="border-color:rgba(251,113,133,.5);color:rgba(251,113,133,.95)">FLAG</span>`:""}
            ${(r.tags||[]).slice(0,3).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}
            ${((r.tags||[]).length>3) ? `<span class="tag">+${(r.tags||[]).length-3}</span>`:""}
          </div>
        </td>
        <td>
          <textarea id="tgt_${r.id}" class="edit" spellcheck="false" placeholder="Type translation‚Ä¶">${escapeHtmlTextarea(r.target||"")}</textarea>
          <div class="cellMeta">
            <span class="tag mono">${escapeHtml(r.fileName||"")}</span>
            <span class="tag mono">${escapeHtml((r.line ?? "‚Äî").toString())}</span>
            <span class="tag">${escapeHtml(r.label||"")}</span>
          </div>
        </td>
      `;

      const chk = tr.querySelector(`#chk_${cssEscape(r.id)}`);
      const ta = tr.querySelector(`#tgt_${cssEscape(r.id)}`);

      const selectRow = (multi=false) => {
        if (!multi) state.view.selectedRowIds.clear();
        if (state.view.selectedRowIds.has(r.id) && multi) state.view.selectedRowIds.delete(r.id);
        else state.view.selectedRowIds.add(r.id);
        state.view.focusedRowId = r.id;
        renderAll({ keepScroll:true });
        syncInspector();
      };

      tr.onclick = (e) => {
        if (e.target === ta || e.target === chk) return;
        selectRow(e.ctrlKey || e.metaKey);
      };

      chk.onchange = (e) => {
        selectRow(true);
      };

      ta.onfocus = () => {
        if (!state.view.selectedRowIds.has(r.id)) {
          state.view.selectedRowIds.clear();
          state.view.selectedRowIds.add(r.id);
          state.view.focusedRowId = r.id;
          renderAll({ keepScroll:true });
          syncInspector();
        }
      };

      ta.oninput = async () => {
        const v = ta.value;
        const row = state.project.rows.find(x => x.id === r.id);
        if (!row) return;
        if (!state._typing) { pushHistory(); state._typing = true; setTimeout(()=>state._typing=false, 600); }
        row.target = v;
        persist();
        syncStats();
        setStatus("Edited.");
        await tmPut(row.source, row.target, { file: row.fileName, key: row.key });
      };

      ids.stringsTbody.appendChild(tr);
    });

    ids.checkAll.checked = rows.length && rows.every(r => state.view.selectedRowIds.has(r.id));
  };

  const syncStats = () => {
    const files = state.project.files || [];
    const rows = state.project.rows || [];
    ids.projectName.textContent = state.project.name || "Untitled";
    ids.projectLang.textContent = state.project.lang || "en";
    ids.statFiles.textContent = `${files.length} files`;
    ids.statRows.textContent = `${rows.length} rows`;
    ids.statProgress.textContent = `${progressPct()}% done`;
  };

  const syncInspector = async () => {
    const id = state.view.focusedRowId || Array.from(state.view.selectedRowIds)[0];
    const row = (state.project.rows || []).find(r => r.id === id);
    if (!row) {
      ids.ctxFile.textContent = "‚Äî";
      ids.ctxLine.textContent = "‚Äî";
      ids.ctxLabel.textContent = "‚Äî";
      ids.ctxTags.textContent = "‚Äî";
      ids.tmMatches.textContent = "No matches.";
      ids.previewSpeaker.textContent = "‚Äî";
      ids.previewText.textContent = "Select a string to preview.";
      return;
    }
    ids.ctxFile.textContent = row.fileName || "‚Äî";
    ids.ctxLine.textContent = (row.line ?? "‚Äî").toString();
    ids.ctxLabel.textContent = row.label || "‚Äî";
    ids.ctxTags.textContent = (row.tags && row.tags.length) ? row.tags.join(", ") : "‚Äî";
    ids.previewSpeaker.textContent = row.speaker ? row.speaker : "Narration";
    ids.previewText.textContent = row.target?.trim() ? row.target : row.source;

    const matches = await tmFind(row.source);
    state.tm.lastMatches = matches;
    ids.tmMatches.textContent = matches.length
      ? `Match: ${matches[0].tgt}`
      : "No matches.";
  };

  const renderAll = (opt={}) => {
    const wrap = $("tableWrap");
    const st = opt.keepScroll ? { top: wrap.scrollTop, left: wrap.scrollLeft } : null;
    renderTree();
    renderTable();
    syncStats();
    if (st) { wrap.scrollTop = st.top; wrap.scrollLeft = st.left; }
    persist();
  };

  const escapeHtml = (s) => normalize(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  const escapeHtmlTextarea = (s) => escapeHtml(s).replace(/\n/g, "\n");
  const cssEscape = (s) => (window.CSS && CSS.escape) ? CSS.escape(s) : s.replace(/[^a-zA-Z0-9_-]/g, "_");

  const sampleProject = () => {
    const f1 = { id: "f1", name: "script.rpy" };
    const f2 = { id: "f2", name: "event_001.rpy" };
    const rows = [
      { id: nowId(), fileId:"f1", fileName:f1.name, key:"l_0001", speaker:"Masachika", source:"Either way, I'm sure it'll be plenty enjoyable.", target:"", line:153, label:"dialogue", tags:["dialogue"], flagged:false },
      { id: nowId(), fileId:"f1", fileName:f1.name, key:"l_0002", speaker:"Alya", source:"Thank you for the meal!", target:"", line:282, label:"dialogue", tags:["dialogue"], flagged:false },
      { id: nowId(), fileId:"f2", fileName:f2.name, key:"l_0101", speaker:"Narration", source:"You linger outside for a moment before going in.", target:"", line:298, label:"narration", tags:["narration"], flagged:false },
    ];
    state.project = { name:"Demo Project", lang:"vi", files:[f1,f2], rows };
    state.view.activeFileId = "f1";
    state.view.selectedRowIds.clear();
    state.view.focusedRowId = rows[0].id;
  };

  const exportProject = () => {
    const out = {
      schema: "rpw.project.v1",
      name: state.project.name,
      lang: state.project.lang,
      files: state.project.files,
      rows: state.project.rows,
      glossary: state.glossary,
      exportedAt: new Date().toISOString()
    };
    download(`${(state.project.name||"project").replace(/\s+/g,"_")}.json`, JSON.stringify(out, null, 2));
    setStatus("Exported JSON.");
  };

  const importProjectJson = async (text) => {
    const obj = JSON.parse(text);
    if (obj.schema && obj.schema.startsWith("rpw.project")) {
      pushHistory();
      state.project = { name: obj.name || "Untitled", lang: obj.lang || "en", files: obj.files || [], rows: obj.rows || [] };
      state.glossary = obj.glossary || {};
      state.view.activeFileId = state.project.files?.[0]?.id ?? null;
      state.view.selectedRowIds.clear();
      state.view.focusedRowId = state.project.rows?.[0]?.id ?? null;
      renderAll();
      await syncInspector();
      setStatus("Imported project JSON.");
      return;
    }
    throw new Error("Unsupported JSON format.");
  };

  const openFilePicker = () => ids.filePicker.click();
  const openImportPicker = () => ids.importPicker.click();

  const buildFindReplaceModal = () => {
    const body = document.createElement("div");
    body.className = "grid2";

    const left = document.createElement("div");
    left.innerHTML = `
      <div class="small">Scope</div>
      <div class="pill" style="justify-content:space-between;margin-top:6px">
        <span class="small">Active file only</span>
        <input id="frScopeFile" type="checkbox" checked />
      </div>
      <div class="pill" style="justify-content:space-between;margin-top:8px">
        <span class="small">Target only</span>
        <input id="frTargetOnly" type="checkbox" checked />
      </div>
      <div class="hr"></div>
      <div class="small">Find</div>
      <input id="frFind" class="input" style="width:100%;margin-top:6px" placeholder="Text to find" />
      <div class="small" style="margin-top:10px">Replace</div>
      <input id="frReplace" class="input" style="width:100%;margin-top:6px" placeholder="Replacement" />
      <div class="pill" style="justify-content:space-between;margin-top:8px">
        <span class="small">Case sensitive</span>
        <input id="frCase" type="checkbox" />
      </div>
    `;

    const right = document.createElement("div");
    right.innerHTML = `
      <div class="small">Results</div>
      <div id="frResults" style="margin-top:6px;border:1px solid var(--line);border-radius:14px;overflow:auto;max-height:44vh;background:rgba(0,0,0,.25)"></div>
      <div class="small" style="margin-top:10px">Tip: Double-click a result to select the row.</div>
    `;

    body.appendChild(left);
    body.appendChild(right);

    const footer = document.createElement("div");
    footer.style.display = "flex";
    footer.style.gap = "8px";
    footer.innerHTML = `
      <button id="frBtnScan" class="btn">Scan</button>
      <button id="frBtnReplaceAll" class="btn primary">Replace All</button>
    `;

    const scan = () => {
      const find = normalize(body.querySelector("#frFind").value);
      const rep = normalize(body.querySelector("#frReplace").value);
      const inFile = body.querySelector("#frScopeFile").checked;
      const targetOnly = body.querySelector("#frTargetOnly").checked;
      const cs = body.querySelector("#frCase").checked;
      const resultsEl = body.querySelector("#frResults");

      const rows = (state.project.rows || []).filter(r => !inFile || !state.view.activeFileId || r.fileId === state.view.activeFileId);
      const hay = (r) => targetOnly ? normalize(r.target) : (normalize(r.source) + "\n" + normalize(r.target));
      const test = (txt) => {
        if (!find) return false;
        if (cs) return txt.includes(find);
        return txt.toLowerCase().includes(find.toLowerCase());
      };

      const hits = rows.filter(r => test(hay(r))).slice(0, 500);
      resultsEl.innerHTML = hits.length ? "" : `<div class="small" style="padding:10px;color:var(--muted)">No hits.</div>`;
      hits.forEach(r => {
        const item = document.createElement("div");
        item.id = `frHit_${r.id}`;
        item.style.padding = "10px";
        item.style.borderBottom = "1px solid var(--line)";
        item.style.cursor = "pointer";
        item.innerHTML = `
          <div class="small mono">${escapeHtml(r.fileName||"")} ‚Ä¢ ${escapeHtml(r.key||r.id)}</div>
          <div style="margin-top:6px;white-space:pre-wrap">${escapeHtml((targetOnly?r.target:r.source) || "")}</div>
        `;
        item.ondblclick = () => {
          closeModal();
          pushHistory();
          state.view.activeFileId = r.fileId;
          state.view.selectedRowIds.clear();
          state.view.selectedRowIds.add(r.id);
          state.view.focusedRowId = r.id;
          renderAll();
          syncInspector();
          const ta = $("tgt_"+r.id);
          if (ta) { ta.scrollIntoView({ block:"center" }); ta.focus(); }
          setStatus("Selected search hit.");
        };
        resultsEl.appendChild(item);
      });

      return { find, rep, hits, inFile, targetOnly, cs };
    };

    footer.querySelector("#frBtnScan").onclick = () => { scan(); setStatus("Scanned."); };

    footer.querySelector("#frBtnReplaceAll").onclick = async () => {
      const { find, rep, hits, targetOnly, cs } = scan();
      if (!find || !hits.length) return;
      pushHistory();
      const rx = cs ? new RegExp(escapeRegExp(find), "g") : new RegExp(escapeRegExp(find), "gi");
      hits.forEach(r => {
        const row = state.project.rows.find(x => x.id === r.id);
        if (!row) return;
        if (targetOnly) row.target = normalize(row.target).replace(rx, rep);
        else row.target = normalize(row.target).replace(rx, rep);
      });
      renderAll();
      await syncInspector();
      setStatus(`Replaced in ${hits.length} row(s).`);
    };

    return { body, footer };
  };

  const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

  const buildSettingsModal = () => {
    const body = document.createElement("div");
    body.innerHTML = `
      <div class="grid2">
        <div>
          <div class="small">Project</div>
          <div class="hr"></div>
          <div class="small">Name</div>
          <input id="setName" class="input" style="width:100%;margin-top:6px" value="${escapeHtmlTextarea(state.project.name||"")}" />
          <div class="small" style="margin-top:10px">Language</div>
          <input id="setLang" class="input" style="width:100%;margin-top:6px" value="${escapeHtmlTextarea(state.project.lang||"en")}" />
          <div class="small" style="margin-top:10px">Auto-save</div>
          <div class="pill" style="justify-content:space-between;margin-top:6px">
            <span class="small">Enabled</span>
            <input id="setAutosave" type="checkbox" checked />
          </div>
        </div>
        <div>
          <div class="small">Engines (placeholder)</div>
          <div class="hr"></div>
          <div class="small">Provider</div>
          <select id="setProvider" class="select" style="width:100%;margin-top:6px">
            <option>Manual</option>
            <option>Google</option>
            <option>DeepL</option>
            <option>OpenAI</option>
            <option>Custom REST</option>
          </select>
          <div class="small" style="margin-top:10px">API Key</div>
          <input id="setApiKey" class="input" style="width:100%;margin-top:6px" placeholder="Stored locally (not sent anywhere in this scaffold)" />
          <div class="small" style="margin-top:10px">Rate limit</div>
          <input id="setRps" class="input" style="width:100%;margin-top:6px" value="2" />
        </div>
      </div>
      <div class="hr"></div>
      <div class="small">Glossary entries: <span class="mono">${Object.keys(state.glossary||{}).length}</span></div>
    `;

    const footer = document.createElement("div");
    footer.style.display = "flex";
    footer.style.gap = "8px";
    footer.innerHTML = `
      <button id="setBtnClear" class="btn danger">Clear Local Data</button>
      <button id="setBtnApply" class="btn primary">Apply</button>
    `;

    footer.querySelector("#setBtnClear").onclick = () => {
      localStorage.removeItem("rpw_project");
      localStorage.removeItem("rpw_view");
      localStorage.removeItem("rpw_glossary");
      setStatus("Cleared local data.");
    };

    footer.querySelector("#setBtnApply").onclick = () => {
      pushHistory();
      state.project.name = body.querySelector("#setName").value.trim() || "Untitled";
      state.project.lang = body.querySelector("#setLang").value.trim() || "en";
      persist();
      syncStats();
      setStatus("Settings applied.");
      closeModal();
    };

    return { body, footer };
  };

  const applyTMToSelection = async () => {
    const idsSel = Array.from(state.view.selectedRowIds);
    if (!idsSel.length) return setStatus("No rows selected.");
    pushHistory();
    let applied = 0;
    for (const id of idsSel) {
      const row = state.project.rows.find(r => r.id === id);
      if (!row) continue;
      if (normalize(row.target).trim()) continue;
      const matches = await tmFind(row.source);
      if (matches.length) {
        row.target = matches[0].tgt;
        applied++;
      }
    }
    renderAll();
    await syncInspector();
    setStatus(applied ? `Applied TM to ${applied} row(s).` : "No TM matches to apply.");
  };

  const toggleFlagSelection = () => {
    const idsSel = Array.from(state.view.selectedRowIds);
    if (!idsSel.length) return setStatus("No rows selected.");
    pushHistory();
    const rows = idsSel.map(id => state.project.rows.find(r => r.id === id)).filter(Boolean);
    const to = !rows.every(r => r.flagged);
    rows.forEach(r => r.flagged = to);
    renderAll({ keepScroll:true });
    syncInspector();
    setStatus(to ? "Flagged selection." : "Unflagged selection.");
  };

  const copySource = async () => {
    const id = state.view.focusedRowId || Array.from(state.view.selectedRowIds)[0];
    const row = state.project.rows.find(r => r.id === id);
    if (!row) return;
    await navigator.clipboard.writeText(row.source || "");
    setStatus("Copied source.");
  };

  const addToGlossary = () => {
    const id = state.view.focusedRowId || Array.from(state.view.selectedRowIds)[0];
    const row = state.project.rows.find(r => r.id === id);
    if (!row) return setStatus("Select a row.");
    const src = normalize(row.source).trim();
    const tgt = normalize(row.target).trim();
    if (!src || !tgt) return setStatus("Need both source and translation to add.");
    pushHistory();
    state.glossary[src] = tgt;
    persist();
    setStatus("Added to glossary.");
  };

  const wireUI = () => {
    $("btnOpen").onclick = openFilePicker;
    $("btnSave").onclick = () => { persist(); setStatus("Saved locally."); };
    $("btnExport").onclick = exportProject;
    $("btnImport").onclick = openImportPicker;
    $("btnUndo").onclick = undo;
    $("btnRedo").onclick = redo;

    $("btnFindReplace").onclick = () => {
      const { body, footer } = buildFindReplaceModal();
      openModal("Find & Replace", body, footer);
      setStatus("Find/Replace opened.");
    };

    $("btnSettings").onclick = () => {
      const { body, footer } = buildSettingsModal();
      openModal("Settings", body, footer);
    };

    $("btnApplyTM").onclick = applyTMToSelection;
    $("btnFlag").onclick = toggleFlagSelection;
    $("btnCopySource").onclick = copySource;
    $("btnAddToGlossary").onclick = addToGlossary;

    $("btnModalClose").onclick = closeModal;
    ids.modalOverlay.onclick = (e) => { if (e.target === ids.modalOverlay) closeModal(); };

    ids.inputFileFilter.oninput = renderTree;
    ids.inputQuickSearch.oninput = () => {
      state.view.quickSearch = ids.inputQuickSearch.value;
      renderTable();
      syncStats();
    };

    ids.checkAll.onchange = () => {
      pushHistory();
      const rows = getFilteredRows();
      if (ids.checkAll.checked) rows.forEach(r => state.view.selectedRowIds.add(r.id));
      else rows.forEach(r => state.view.selectedRowIds.delete(r.id));
      renderAll({ keepScroll:true });
      syncInspector();
      setStatus("Selection updated.");
    };

    document.querySelectorAll("[data-tab]").forEach(t => {
      t.onclick = () => {
        pushHistory();
        document.querySelectorAll("[data-tab]").forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        state.view.tab = t.dataset.tab;
        state.view.selectedRowIds.clear();
        state.view.focusedRowId = null;
        renderAll();
        syncInspector();
        setStatus(`Tab: ${t.textContent}`);
      };
    });

    ids.filePicker.onchange = async () => {
      const f = ids.filePicker.files?.[0];
      ids.filePicker.value = "";
      if (!f) return;
      try {
        const text = await f.text();
        await importProjectJson(text);
      } catch (e) {
        setStatus("Open failed.");
        alert("Unsupported file.\n\nExpected: rpw.project.v1 JSON.");
      }
    };

    ids.importPicker.onchange = async () => {
      const f = ids.importPicker.files?.[0];
      ids.importPicker.value = "";
      if (!f) return;
      const name = f.name.toLowerCase();
      try {
        if (name.endsWith(".json")) {
          await importProjectJson(await f.text());
          return;
        }
        if (name.endsWith(".csv")) {
          const txt = await f.text();
          importCsv(txt);
          setStatus("Imported CSV.");
          return;
        }
        alert("Import supports JSON/CSV only.");
      } catch {
        alert("Import failed.");
      }
    };

    window.addEventListener("keydown", async (e) => {
      const k = e.key.toLowerCase();
      if ((e.ctrlKey || e.metaKey) && k === "s") { e.preventDefault(); persist(); setStatus("Saved locally."); }
      if ((e.ctrlKey || e.metaKey) && k === "f") { e.preventDefault(); $("btnFindReplace").click(); }
      if ((e.ctrlKey || e.metaKey) && k === "z" && !e.shiftKey) { e.preventDefault(); undo(); }
      if (((e.ctrlKey || e.metaKey) && (k === "y" || (k==="z" && e.shiftKey)))) { e.preventDefault(); redo(); }
      if (k === "f" && !e.ctrlKey && !e.metaKey && !isTyping()) { e.preventDefault(); toggleFlagSelection(); }
      if (k === "t" && !e.ctrlKey && !e.metaKey && !isTyping()) { e.preventDefault(); await applyTMToSelection(); }
      if (k === "escape") closeModal();
    });
  };

  const isTyping = () => {
    const el = document.activeElement;
    return el && (el.tagName === "TEXTAREA" || el.tagName === "INPUT");
  };

  const importCsv = (csv) => {
    const lines = csv.split(/\r?\n/).filter(Boolean);
    const header = (lines.shift() || "").split(",").map(s=>s.trim());
    const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());
    const iFile = idx("file"), iKey = idx("key"), iSpeaker = idx("speaker"), iSource = idx("source"), iTarget = idx("target"), iLine = idx("line"), iLabel = idx("label"), iTags = idx("tags");
    const mapFile = new Map();
    const files = [];
    const rows = [];
    lines.forEach(line => {
      const cols = parseCsvLine(line);
      const fileName = cols[iFile] || "unknown.rpy";
      if (!mapFile.has(fileName)) {
        const f = { id: nowId(), name: fileName };
        mapFile.set(fileName, f.id);
        files.push(f);
      }
      rows.push({
        id: nowId(),
        fileId: mapFile.get(fileName),
        fileName,
        key: cols[iKey] || "",
        speaker: cols[iSpeaker] || "",
        source: cols[iSource] || "",
        target: cols[iTarget] || "",
        line: cols[iLine] ? Number(cols[iLine]) : null,
        label: cols[iLabel] || "",
        tags: (cols[iTags] || "").split("|").map(s=>s.trim()).filter(Boolean),
        flagged: false
      });
    });
    pushHistory();
    state.project.files = files;
    state.project.rows = rows;
    state.view.activeFileId = files[0]?.id ?? null;
    state.view.selectedRowIds.clear();
    state.view.focusedRowId = rows[0]?.id ?? null;
    renderAll();
    syncInspector();
  };

  const parseCsvLine = (line) => {
    const out = [];
    let cur = "", inQ = false;
    for (let i=0;i<line.length;i++){
      const c = line[i];
      if (c === '"' && line[i+1] === '"'){ cur += '"'; i++; continue; }
      if (c === '"'){ inQ = !inQ; continue; }
      if (c === "," && !inQ){ out.push(cur); cur=""; continue; }
      cur += c;
    }
    out.push(cur);
    return out;
  };

  const init = async () => {
    await initTM();
    loadPersisted();
    if (!state.project.files?.length) sampleProject();
    wireUI();
    renderAll();
    await syncInspector();
    setStatus("Ready.");
  };

  init();
})();
</script>
</body>
</html>