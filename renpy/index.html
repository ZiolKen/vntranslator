<!DOCTYPE html>
<html lang="en">
 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <title>Ren'Py RPY Translator</title>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="renpy.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <meta name="theme-color" content="#000000">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Turret+Road:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
 
<body>
  <div id="particles-js"></div>
  <div class="grid-bg"></div>
  <!-- Modal for Lingva Warning -->
  <div id="libreWarningModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Important Notice About Lingva Translate</h3>
      <div class="notice-content">
        <ul class="notice-list">
          <li>Lingva is a free service that may not perfectly preserve Ren'Py code structure.</li>
          <li>We recommend using it only for testing purposes or when you're willing to manually review the results.</li>
          <li>For production use or accurate translations that maintain all Ren'Py formatting, please use DeepSeek.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button id="confirmLibre" style="border-color: var(--neon-yellow); color: var(--neon-yellow);">
          I Understand
        </button>
      </div>
    </div>
  </div>
  
  <div class="main-title">
    <h1 id="main-title" class="floating" style="font-size: 3rem; font-weight: 900; margin-bottom: 1rem; animation: floating 3s ease-in-out infinite; color: #fff; text-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff;">Ren'Py RPY <span style="background: linear-gradient(to right, #c084fc, #f472b6, #c084fc); -webkit-background-clip: text; color: transparent; background-clip: text;">Translator</span>
    </h1>
    <div class="card cyber-grid">
      <h4>Translation Settings</h4>

      <div class="form-group">
        <label>Translation Model</label>
        <select id="modelSelect">
          <option value="deepseek">üî• DeepSeek API ‚Äî High Quality (Paid)</option>
          <option value="libre">üåê Lingva ‚Äî Free (Lower Quality)</option>
        </select>
      </div>
      <div class="form-group" id="apiKeyContainer">
        <label>DeepSeek API Key</label>
        <input id="apiKey" type="password" placeholder="Enter your API Key">
      </div>
      <div class="form-group">
        <label>Target Language</label>
        <select id="langTarget">
          <option value="Bahasa Indonesia">Indonesian</option>
          <option value="English">English</option>
          <option value="Malay">Malay</option>
          <option value="Vietnamese">Vietnamese</option>
          <option value="Filipino">Filipino</option>
        </select>
      </div>
      <div class="form-group">
        <label>Upload .rpy File</label>
        <input id="fileInput" type="file" accept=".rpy">
      </div>
      <div class="progress-container">
        <label>Progress</label>
        <progress id="progressBar" value="0" max="1000"></progress>
        <div id="progressText">0/0</div>
      </div>
    </div>
      <div class="card cyber-grid">
        <h5>Translation Control</h5>
        <div class="button-group">
        <button id="translateBtn">
          <span id="translateLabel"><span>‚ñ∂Ô∏è</span> Start Translating</span>
          <span id="spinner" class="hidden"></span>
        </button>
        <button id="downloadFinal"><span>‚¨áÔ∏è</span> Download Result</button>
        <button id="downloadProgress"><span>‚¨áÔ∏è</span> Download Log</button>
        <button id="previewBtn" disabled><span>‚ÑπÔ∏è</span> Preview/Edit Manual</button>
        </div>
      </div>
    <div class="card cyber-grid" style="margin-bottom: 25px;">
      <h2>Translation Log</h2>
      <div id="logBox" class="log-container">[SYSTEM_BOOT] :: Awaiting input...</div>
    <div>
      <div id="controlBtns" style="display:none; margin-top: 10px;">
        <button id="stopBtn"><span>‚è∏</span> Stop Translation</button>
        <button id="resumeBtn" disabled><span>üîÑ</span> Resume Translation</button>
      </div>
    </div>
    </div>
  <div class="card cyber-grid" style="margin-bottom: 25px;">
    <h6>Support & Resources</h6>
      <div class="support-grid" style="display: grid; grid-template-columns: 1fr; gap: 15px; @media (min-width: 768px) { grid-template-columns: 1fr 1fr; }">
        <div style="grid-column: 1 / -1;">
          <p class="support-label" style="font-weight: bold; color: var(--neon-yellow); margin-bottom: 10px; margin-top: 15px;">GET HELP:</p>
            <a href="rpy-dialog-extractor.html" target="_blank" rel="noopener noreferrer" class="help-btn"><span class="help-icon">üîÑ</span>Extract RPY dialogs & Merge</a>
            <a href="https://grviewer.com/" target="_blank" rel="noopener noreferrer" class="help-btn"><span class="help-icon">üîÅ</span>Extract RPA & Decompile RPYC</a>
            <a href="how-to-get-deepseek-api-key.html" target="_blank" rel="noopener noreferrer" class="help-btn"><span class="help-icon">‚ùì</span>How to get a DeepSeek API Key?</a>
            <a href="how-to-get-renpy-rpy.html" target="_blank" rel="noopener noreferrer" class="help-btn"><span class="help-icon">üìÇ</span>How to get RPY file from game?</a>
        </div>
  </div>
</div>
  <div class="card usage-tips">
    <h6>Notice</h6>
    <div class="notice-content">
      <p><strong>Suggest:</strong></p>
      <ul class="notice-list">
        <li>It is recommended to use the RPY Dialog Extraction & Merge Tool to extract the dialog and translate, then merge the translated RPY with the original RPY.</li>
      </ul>
      <p><strong>Important:</strong></p>
      <ul class="notice-list">
        <li>DeepSeek requires an API key but provides higher quality translations that preserve Ren'Py formatting.</li>
        <li>Lingva is free but may require manual adjustments.</li>
      </ul>
    </div>
  </div>

  <div class="footer-note">
    ‚ö†Ô∏è By using this tool, you agree to accept all kinds of risks.
  </div>

  <div style="text-align: center; margin: 40px 0 20px;">
  <a href="../" class="back-btn">‚¨ÖÔ∏è Back to Main Menu</a>
  </div>
  </div>

<style>
  #particles-js,
  .grid-bg {
    z-index: -1;
  }

  .card,
  button,
  select,
  input,
  textarea,
  h1, h2, h3, h4, h5, h6 {
    position: relative;
    z-index: 1;
  }

  .close-modal {
      color: var(--text-secondary);
      float: right;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
  }
  
  .close-modal:hover {
      color: var(--text-secondary);
  }
    
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const particleCount = isMobile ? 55 : 111;
        particlesJS("particles-js", {
            "particles": {
                "number": {
                    "value": particleCount,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": { "value": "#a855f7" },
                "shape": {
                    "type": "circle",
                    "stroke": { "width": 0, "color": "#000" }
                },
                "opacity": {
                    "value": 0.7,
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 0.5,
                        "opacity_min": 0.3,
                        "sync": false
                    }
                },
                "size": {
                    "value": 3,
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 2,
                        "size_min": 0.3,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#a855f7",
                    "opacity": 0.3,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 1.5,
                    "direction": "none",
                    "random": false,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": { "enable": true, "mode": "repulse" },
                    "onclick": { "enable": false },
                    "resize": true
                },
                "modes": {
                    "repulse": { "distance": 100, "duration": 0.4 }
                }
            },
            "retina_detect": true
        });
</script>
 
<script>
(function () {
  'use strict';

  const el = {
    fileInput: document.getElementById('fileInput'),
    translateBtn: document.getElementById('translateBtn'),
    translateLabel: document.getElementById('translateLabel'),
    spinner: document.getElementById('spinner'),
    progressBar: document.getElementById('progressBar'),
    progressText: document.getElementById('progressText'),
    logBox: document.getElementById('logBox'),
    previewBtn: document.getElementById('previewBtn'),
    downloadFinal: document.getElementById('downloadFinal'),
    downloadProgress: document.getElementById('downloadProgress'),
    modelSelect: document.getElementById('modelSelect'),
    apiKeyContainer: document.getElementById('apiKeyContainer'),
    apiKey: document.getElementById('apiKey'),
    controlBtns: document.getElementById('controlBtns'),
    stopBtn: document.getElementById('stopBtn'),
    resumeBtn: document.getElementById('resumeBtn'),
    libreWarningModal: document.getElementById('libreWarningModal'),
    libreWarningClose: document.querySelector('#libreWarningModal .close-modal'),
    confirmLibre: document.getElementById('confirmLibre'),
    langTarget: document.getElementById('langTarget'),
  };

  const state = {
    fileName: null,
    originalText: '',
    originalLines: [],
    dialogs: [],
    batches: [],
    isTranslating: false,
    isPaused: false,
    currentBatchIndex: 0,
    logEntries: [],
  };

  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  function languageLabel(code) {
    switch (code) {
      case 'id': return 'Indonesian';
      case 'en': return 'English';
      case 'ms': return 'Malay';
      case 'vi': return 'Vietnamese';
      case 'fil': return 'Filipino';
      default: return code;
    }
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.innerText = str;
    return div.innerHTML;
  }

  function estimateTokens(text) {
    if (typeof TextEncoder === 'undefined') {
      return Math.ceil(text.length / 4);
    }
    const bytes = new TextEncoder().encode(text);
    return Math.ceil(bytes.length / 4);
  }

  function createBatches(dialogs, options) {
    const maxLines = options.maxLines ?? 64;
    const maxTokens = options.maxTokens ?? 2000;
    const batches = [];

    let currentBatch = [];
    let currentTokens = 0;

    for (const dialog of dialogs) {
      const text = dialog.quote || '';
      const tokens = estimateTokens(text) + 8; // small overhead per line

      if (currentBatch.length > 0 &&
          (currentBatch.length >= maxLines || currentTokens + tokens > maxTokens)) {
        batches.push(currentBatch);
        currentBatch = [];
        currentTokens = 0;
      }

      currentBatch.push(dialog);
      currentTokens += tokens;
    }

    if (currentBatch.length > 0) {
      batches.push(currentBatch);
    }

    return batches;
  }

  function log(message, level = 'info') {
    const now = new Date();
    const time = now.toISOString().split('T')[1].replace('Z', '');
    const levelTag = level.toUpperCase();
    const entryText = `[${time}] [${levelTag}] ${message}`;

    state.logEntries.push(entryText);

    if (!el.logBox) return;
    const p = document.createElement('p');
    p.textContent = entryText;
    p.dataset.level = level;
    el.logBox.appendChild(p);
    el.logBox.scrollTop = el.logBox.scrollHeight;
  }

  function setTranslateButtonBusy(isBusy, labelWhenBusy = 'üîÅ Translating...') {
    if (!el.translateBtn || !el.translateLabel || !el.spinner) return;

    if (isBusy) {
      el.translateBtn.disabled = true;
      el.translateLabel.textContent = labelWhenBusy;
      el.spinner.style.display = 'inline-block';
    } else {
      el.translateBtn.disabled = false;
      el.translateLabel.textContent = '‚ñ∂Ô∏è Start Translating';
      el.spinner.style.display = 'none';
    }
  }

  function resetTranslateUIAfterFinish() {
    state.isTranslating = false;
    state.isPaused = false;
    setTranslateButtonBusy(false);
    if (el.controlBtns) el.controlBtns.style.display = 'none';
    if (el.stopBtn) el.stopBtn.disabled = true;
    if (el.resumeBtn) el.resumeBtn.disabled = true;
  }

  function updateProgress() {
    const total = state.dialogs.length;
    const done = state.dialogs.filter(d => d.translated != null).length;

    if (el.progressBar) {
      el.progressBar.max = total || 1;
      el.progressBar.value = done;
    }

    if (el.progressText) {
      el.progressText.textContent = `${done} / ${total || 0} lines translated`;
    }
  }

  function updateControlButtons() {
    if (!el.controlBtns || !el.stopBtn || !el.resumeBtn) return;

    if (!state.isTranslating) {
      el.controlBtns.style.display = 'none';
      el.stopBtn.disabled = true;
      el.resumeBtn.disabled = true;
      return;
    }

    el.controlBtns.style.display = 'flex';
    el.stopBtn.disabled = state.isPaused;
    el.resumeBtn.disabled = !state.isPaused;
  }

  /**
   * Extract dialog lines from Ren'Py .rpy content.
   * Heuristics:
   * - Skip empty lines and comments starting with '#'
   * - Look for first and last double quote (")
   * - Anything between them is treated as dialog text, if it has letters/digits
   */
  function isDialogLine(line) {
      const trimmed = line.trim();
      if (trimmed === '') return false;
      if (/#/.test(trimmed)) return false;
      if (/^(#|label\s|menu\s|jump\s|scene\s|init\s|show\s|stop\s|play\s|transform\s|define\s|image\s|window\s|voice\s|pause\s|call\s|return\s|$\s|renpy\s|queue\s|python\s)/i.test(trimmed)) return false;
      if (/^[\w\s]*=[^"]/.test(trimmed)) return false;
      if (/\.(png|jpg|jpeg|webp|gif|ogg|mp3|wav|mp4|webm|m4a|avi|mov|ttf|otf|pfb|pfm|ps|woff|woff2|eot|svg)["']?/i.test(trimmed)) return false;
      if (/["'](images?|audio|music|voice|bg|sfx|movie|video|sounds?)\//i.test(trimmed)) return false;
      const keywords = ["screen", "background", "outlines", "outline_scaling", "=", "_", "font", "text", "text_font", "style", "add", "action", "show", "play", "image", "sound"];
      const outsideQuotes = trimmed.replace(/"[^"]*"|'[^']*'/g, "");
      if (keywords.some(kw => new RegExp(`\\b${kw}\\b`, "i").test(outsideQuotes))) return false;
      if (/^[\w\s]*:\s*["'].*["']/.test(trimmed)) return true;
      if (/^["'].*["']/.test(trimmed)) return true;
      const q = trimmed.match(/(['"])(.*)\1/);
      if (q) {
          const t = q[2].trim();
          if (t === "" || /^[.\s]+$/.test(t)) return false;
      }
      if (/{.*?}/.test(trimmed) && /[\w\-\?!'"]/i.test(trimmed)) return true;
      if (/^[\w\s]*\s*".+?"\s*$/.test(trimmed)) return true;
      return false;
  }
    
  const dialogLines = [];

  for (const file of files) {
      const text = await file.text();
      const lines = text.split(/\r?\n/);

      lines.forEach((line, index) => {
          if (!isDialogLine(line)) return;

          const match = line.match(/"((?:\\.|[^"\\])*)"/);
          if (!match) return;

          const dialogText = match[1];
          if (dialogText.trim() === "" || /^[.\s]+$/.test(dialogText)) return;

          dialogLines.push({
              fileName: file.name,
              lineNumber: index + 1,
              originalLine: line,
              originalText: dialogText
          });
      });
  }

  log(`‚ÑπÔ∏è Detected ${dialogLines.length} dialog lines. Creating translation batches...`, "info");

  async function translateBatchDeepSeek(batchDialogs, targetLang, apiKey) {
    const lines = batchDialogs.map(d => d.quote);
    const languageName = languageLabel(targetLang);

    const userPromptLines = [
      `Translate the following Ren'Py dialogue lines to ${languageName} (language code: ${targetLang}).`,
      '',
      'Rules:',
      '- Preserve Ren\'Py syntax, variables, and tags (e.g. {color}, {size}, [variable], etc.).',
      '- Do NOT change placeholders or variables.',
      '- Do NOT reorder, merge, or split lines.',
      '- Return ONLY the translated lines, one per line, in the same order.',
      '- Do NOT add numbering, quotes, prefixes, or extra commentary.',
      '',
      'Lines:'
    ];

    const prompt = userPromptLines.concat(lines).join('\n');

    const body = {
      model: 'deepseek-chat',
      messages: [
        {
          role: 'system',
          content: 'You are a professional game localization translator specializing in Ren\'Py visual novels.'
        },
        {
          role: 'user',
          content: prompt
        }
      ]
    };

    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + apiKey
      },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      const text = await response.text();
      throw new Error(`*Ô∏è‚É£ DeepSeek API error ${response.status}: ${text}`);
    }

    const data = await response.json();
    const content =
      data &&
      data.choices &&
      data.choices[0] &&
      data.choices[0].message &&
      data.choices[0].message.content;

    if (!content) {
      throw new Error('*Ô∏è‚É£ DeepSeek response did not contain any content.');
    }

    const outLines = content
      .split(/\r?\n/)
      .map(l => l.trim())
      .filter(l => l !== '');

    if (outLines.length !== lines.length) {
      log(
        `*Ô∏è‚É£ Warning: expected ${lines.length} lines from DeepSeek but got ${outLines.length}. Mapping by order anyway.`,
        'warn'
      );
    }

    return outLines;
  }
  
  const LINGVA_LANG_MAP = {
    Vietnamese: 'vi',
    'vi-VN': 'vi',
    English: 'en',
    'en-US': 'en',
    'en-GB': 'en',
    Filipino: 'tl',
    Indonesian: 'id',
    Malay: 'ms',
  };

  function getLingvaLangCode(lang) {
    if (!lang) return 'en';

    const trimmed = String(lang).trim();

    if (/^[a-z]{2}(-[A-Za-z0-9]+)?$/i.test(trimmed)) {
      return trimmed.toLowerCase();
    }

    const key = Object.keys(LINGVA_LANG_MAP).find(
      (k) => k.toLowerCase() === trimmed.toLowerCase()
    );

    return key ? LINGVA_LANG_MAP[key] : trimmed;
  }
  
  const LINGVA_BASE_URLS = [
    'https://lingva.lunar.icu',
    'https://lingva.ml',
    'https://lingva.vercel.app',
    'https://translate.plausibility.cloud',
    'https://lingva.garudalinux.org',
  ];
  
  async function lingvaFetch(path, init) {
    let lastError;

    for (const base of LINGVA_BASE_URLS) {
      const url = base.replace(/\/+$/, '') + path;

      try {
        console.info('[Lingva] Trying:', url);
        const res = await fetch(url, init);

        if (!res.ok) {
          console.warn(
            '[Lingva] HTTP error',
            res.status,
            res.statusText,
            'at',
            base
          );
          lastError = new Error(`*Ô∏è‚É£ HTTP ${res.status} from ${base}`);
          continue;
        }

        return res;
      } catch (err) {
        console.warn('*Ô∏è‚É£ [Lingva] Network error at', base, err);
        lastError = err;
      }
    }

    throw lastError || new Error('*Ô∏è‚É£ All Lingva endpoints failed');
  }

  async function translateBatchLingva(batchDialogs, targetLang) {
    const results = [];

    for (const dialog of batchDialogs) {
      const text = dialog.quote || '';
      if (!text.trim()) {
        results.push(text);
        continue;
      }

      const langCode = getLingvaLangCode(targetLang);
      
      const path =
        '/api/v1/auto/' +
        encodeURIComponent(langCode) +
        '/' +
        encodeURIComponent(text);

      const response = await lingvaFetch(path);
      if (!response.ok) {
        const t = await response.text();
        throw new Error(`*Ô∏è‚É£ Lingva error ${response.status}: ${t}`);
      }

      const data = await response.json();
      const translated =
        data.translation ||
        data.translatedText ||
        data.result ||
        '';

      if (!translated) {
        throw new Error('*Ô∏è‚É£ Lingva response did not contain a translation string.');
      }

      results.push(translated);

      await delay(100);
    }

    return results;
  }

  async function waitWhilePaused() {
    while (state.isPaused && state.isTranslating) {
      await delay(100);
    }
  }

  async function runTranslationLoop() {
    const model = el.modelSelect ? el.modelSelect.value : 'deepseek';
    const apiKey = (el.apiKey && el.apiKey.value.trim()) || '';
    const targetLang = el.langTarget ? el.langTarget.value : 'id';

    updateControlButtons();

    while (
      state.currentBatchIndex < state.batches.length &&
      state.isTranslating
    ) {
      if (state.isPaused) {
        log('‚è∏ Translation paused.', 'info');
        await waitWhilePaused();
        if (!state.isTranslating) {
          log('‚ÑπÔ∏è Translation cancelled while paused.', 'warn');
          return;
        }
        log('‚ñ∂Ô∏è Resuming translation...', 'info');
      }

      const batchNum = state.currentBatchIndex + 1;
      const totalBatches = state.batches.length;
      const batchDialogs = state.batches[state.currentBatchIndex];

      log(
        `üîÑ Translating batch ${batchNum}/${totalBatches} (${batchDialogs.length} lines)...`,
        'info'
      );

      let translatedLines;
      try {
        if (model === 'deepseek') {
          translatedLines = await translateBatchDeepSeek(
            batchDialogs,
            targetLang,
            apiKey
          );
        } else {
          translatedLines = await translateBatchLingva(
            batchDialogs,
            targetLang
          );
        }
      } catch (err) {
        log(
          `*Ô∏è‚É£ Error while translating batch ${batchNum}: ${err.message || err}`,
          'error'
        );
        throw err;
      }

      for (let i = 0; i < batchDialogs.length; i++) {
        if (translatedLines[i]) {
          batchDialogs[i].translated = translatedLines[i];
        }
      }

      state.currentBatchIndex++;
      updateProgress();
    }

    if (state.currentBatchIndex >= state.batches.length) {
      log('‚úÖ Translation complete. You can now download the result.', 'success');
      if (el.downloadFinal) el.downloadFinal.disabled = false;
      if (el.previewBtn) el.previewBtn.disabled = false;
    }

    resetTranslateUIAfterFinish();
  }

  async function startTranslation() {
    if (state.isTranslating) {
      log('‚ÑπÔ∏è A translation is already in progress.', 'warn');
      return;
    }

    if (!state.fileName || !state.originalLines.length) {
      log('*Ô∏è‚É£ No .rpy file loaded. Please upload a file first.', 'error');
      return;
    }

    const model = el.modelSelect ? el.modelSelect.value : 'deepseek';
    const apiKey = (el.apiKey && el.apiKey.value.trim()) || '';
    const targetLang = el.langTarget ? el.langTarget.value : 'id';

    if (model === 'deepseek' && !apiKey) {
      log('*Ô∏è‚É£ Please provide your DeepSeek API key.', 'error');
      return;
    }

    log(
      `‚ÑπÔ∏è Preparing translation using model "${model}" to ${languageLabel(
        targetLang
      )}...`,
      'info'
    );

    state.dialogs = extractDialogsFromLines(state.originalLines);

    if (!state.dialogs.length) {
      log('*Ô∏è‚É£ No dialog lines were detected in this .rpy file.', 'error');
      return;
    }

    log(
      `‚ÑπÔ∏è Detected ${state.dialogs.length} dialog lines. Creating translation batches...`,
      'info'
    );

    state.batches = createBatches(state.dialogs, {
      maxLines: 48,
      maxTokens: 1800,
    });

    log(
      `‚ÑπÔ∏è Created ${state.batches.length} batches for translation.`,
      'info'
    );

    state.currentBatchIndex = 0;
    state.isTranslating = true;
    state.isPaused = false;

    if (el.progressBar) {
      el.progressBar.value = 0;
      el.progressBar.max = state.dialogs.length;
    }
    updateProgress();

    setTranslateButtonBusy(true, 'Translating...');
    if (el.controlBtns) el.controlBtns.style.display = 'flex';
    updateControlButtons();

    try {
      await runTranslationLoop();
    } catch (err) {
      log('*Ô∏è‚É£ Translation stopped due to an error.', 'error');
      resetTranslateUIAfterFinish();
    }
  }

  function buildOutputText() {
    const map = new Map();
    for (const d of state.dialogs) {
      if (d.translated != null) {
        map.set(d.index, d);
      }
    }

    const outLines = state.originalLines.map((line, idx) => {
      const dialog = map.get(idx);
      if (!dialog) return line;
      if (dialog.translated == null) return line;

      const firstQuote = line.indexOf('"');
      const lastQuote = line.lastIndexOf('"');
      if (firstQuote === -1 || lastQuote <= firstQuote) return line;

      return (
        line.slice(0, firstQuote + 1) +
        dialog.translated +
        line.slice(lastQuote)
      );
    });

    return outLines.join('\n');
  }

  function handleDownloadFinal() {
    const output = buildOutputText();

    const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    const baseName = state.fileName
      ? state.fileName.replace(/\.rpy$/i, '')
      : 'translated';
    a.download = baseName + '_translated.rpy';
    a.href = url;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    log('‚¨áÔ∏è Downloaded translated .rpy file.', 'success');
  }

  function handleDownloadProgress() {
    const logText = state.logEntries.join('\n');
    const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.download = 'translation_log.txt';
    a.href = url;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    log('‚¨áÔ∏è Downloaded translation log.', 'success');
  }

  function handlePreview() {
    const output = buildOutputText();
    if (!output) {
      alert('Nothing to preview yet.');
      return;
    }

    const win = window.open('', '_blank', 'width=900,height=700');
    if (!win) {
      alert(
        '*Ô∏è‚É£ Popup blocked. Please allow popups for this site or use Download to view the result.'
      );
      return;
    }

    win.document.write(
      '<!DOCTYPE html><html><head><title>RPY Preview</title></head><body>' +
        '<pre style="white-space: pre-wrap; font-family: monospace; padding: 16px;">' +
        escapeHtml(output) +
        '</pre></body></html>'
    );
    win.document.close();
  }

  function handleFileChange(evt) {
    const file = evt.target.files && evt.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.rpy')) {
      log('*Ô∏è‚É£ Please upload a .rpy file.', 'error');
      evt.target.value = '';
      if (el.translateBtn) el.translateBtn.disabled = true;
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      state.fileName = file.name;
      state.originalText = e.target.result || '';
      state.originalLines = state.originalText.split(/\r?\n/);
      state.dialogs = [];
      state.batches = [];
      state.isTranslating = false;
      state.isPaused = false;
      state.currentBatchIndex = 0;
      state.logEntries = [];

      log(
        `‚ÑπÔ∏è Loaded file "${file.name}" (${state.originalLines.length} lines).`,
        'info'
      );

      if (el.translateBtn) el.translateBtn.disabled = false;
      if (el.downloadFinal) el.downloadFinal.disabled = true;
      if (el.previewBtn) el.previewBtn.disabled = true;

      if (el.progressBar) {
        el.progressBar.value = 0;
        el.progressBar.max = 1;
      }
      if (el.progressText) {
        el.progressText.textContent = '0 / 0 lines translated';
      }
    };
    reader.onerror = () => {
      log('*Ô∏è‚É£ Failed to read file.', 'error');
    };
    reader.readAsText(file, 'utf-8');
  }

  function showLibreModal() {
    if (!el.libreWarningModal) return;
    el.libreWarningModal.style.display = 'flex';
  }

  function hideLibreModal() {
    if (!el.libreWarningModal) return;
    el.libreWarningModal.style.display = 'none';
  }

  function setupModelSelectBehavior() {
    if (!el.modelSelect) return;

    const apply = () => {
      const value = el.modelSelect.value;
      if (value === 'deepseek') {
        if (el.apiKeyContainer) el.apiKeyContainer.style.display = 'block';
      } else {
        if (el.apiKeyContainer) el.apiKeyContainer.style.display = 'none';
        showLibreModal();
      }
    };

    el.modelSelect.addEventListener('change', apply);
    apply();
  }

  function setupModalBehavior() {
    if (el.libreWarningClose) {
      el.libreWarningClose.addEventListener('click', hideLibreModal);
    }
    if (el.confirmLibre) {
      el.confirmLibre.addEventListener('click', hideLibreModal);
    }
    if (el.libreWarningModal) {
      el.libreWarningModal.addEventListener('click', e => {
        if (e.target === el.libreWarningModal) {
          hideLibreModal();
        }
      });
    }
  }

  function init() {
    if (el.fileInput) {
      el.fileInput.addEventListener('change', handleFileChange);
    }

    if (el.translateBtn) {
      el.translateBtn.addEventListener('click', startTranslation);
      el.translateBtn.disabled = true; // until file is loaded
    }

    if (el.stopBtn) {
      el.stopBtn.addEventListener('click', () => {
        if (!state.isTranslating) return;
        state.isPaused = true;
        updateControlButtons();
      });
    }

    if (el.resumeBtn) {
      el.resumeBtn.addEventListener('click', () => {
        if (!state.isTranslating) return;
        state.isPaused = false;
        updateControlButtons();
      });
    }

    if (el.downloadFinal) {
      el.downloadFinal.addEventListener('click', handleDownloadFinal);
      el.downloadFinal.disabled = true;
    }

    if (el.downloadProgress) {
      el.downloadProgress.addEventListener('click', handleDownloadProgress);
    }

    if (el.previewBtn) {
      el.previewBtn.addEventListener('click', handlePreview);
      el.previewBtn.disabled = true;
    }

    setupModelSelectBehavior();
    setupModalBehavior();
    updateControlButtons();
    updateProgress();

    log('‚ÑπÔ∏è Ready. Upload a .rpy file and click "Start Translating".', 'info');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

</body>

</html>