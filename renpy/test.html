<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>.rpy Smart Translator to Vietnamese</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: auto;
        padding: 20px;
        background-color: #f7f7f7;
    }
    textarea {
        width: 100%;
        font-family: monospace;
        font-size: 14px;
        margin-bottom: 10px;
        padding: 10px;
    }
    button, input[type="file"] {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 10px;
    }
    h1, h2 {
        text-align: center;
    }
</style>
</head>
<body>

<h1>.rpy Smart Translator to Vietnamese</h1>

<input type="file" id="fileInput" accept=".rpy,.txt">
<br>
<button id="translateBtn" disabled>Translate to Vietnamese</button>
<button id="downloadBtn" disabled>Download Translated File</button>

<h2>Translated Content:</h2>
<textarea id="outputText" rows="20" readonly></textarea>

<script>
let originalText = '';
const fileInput = document.getElementById('fileInput');
const translateBtn = document.getElementById('translateBtn');
const downloadBtn = document.getElementById('downloadBtn');
const outputText = document.getElementById('outputText');

// Read uploaded file
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
        originalText = evt.target.result;
        outputText.value = originalText;
        translateBtn.disabled = false;
    };
    reader.readAsText(file, 'UTF-8');
});

// Call Lingva translation
async function translateText(text) {
    try {
        const response = await fetch(`https://lingva.ml/api/v1/vi/${encodeURIComponent(text)}`);
        if (!response.ok) throw new Error('Translation failed');
        const data = await response.json();
        return data.translation;
    } catch (err) {
        console.error('Translation error:', err);
        return text;
    }
}

// Translate only the readable content inside quotes, preserving tags
translateBtn.addEventListener('click', async () => {
    if (!originalText) return;
    outputText.value = "Translating... Please wait.";

    // Regex to match content inside quotes
    const regex = /"(.*?)"/gs;
    const matches = [...originalText.matchAll(regex)];

    let translatedText = originalText;

    for (const match of matches) {
        const fullMatch = match[0]; // "...."
        let content = match[1]; // inside quotes

        // Split content into text and tags
        const tagRegex = /{.*?}/g;
        const tags = content.match(tagRegex) || [];
        const cleanText = content.replace(tagRegex, '').trim();

        if (cleanText.length === 0) continue; // skip if only tags

        // Translate clean text
        const translated = await translateText(cleanText);

        // Recombine translated text with original tags in order
        const newContent = translated + tags.join('');

        // Replace original match with new translated content
        translatedText = translatedText.replace(fullMatch, `"${newContent}"`);
    }

    outputText.value = translatedText;
    downloadBtn.disabled = false;
});

// Download translated file
downloadBtn.addEventListener('click', () => {
    const blob = new Blob([outputText.value], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'translated.rpy';
    a.click();
    URL.revokeObjectURL(url);
});
</script>

</body>
</html>
