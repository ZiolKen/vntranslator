<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta content="ie=edge" http-equiv="X-UA-Compatible">
  <title>Ren'Py RPY Translator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="renpy.css">
</head>

<body class="bg-gray-900 text-white min-h-screen px-4 py-6">
  <!-- Modal for Lingva Warning -->
  <div id="libreWarningModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3 class="text-lg font-bold mb-3 text-amber-400">Important Notice About Lingva Translate</h3>
      <p class="text-sm mb-4">
        Lingva is a free service that may not perfectly preserve Ren'Py code structure. 
        We recommend using it only for testing purposes or when you're willing to manually review the results.
      </p>
      <p class="text-sm mb-4">
        For production use or accurate translations that maintain all Ren'Py formatting, please use DeepSeek.
      </p>
      <div class="flex justify-end">
        <button id="confirmLibre" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded">
          I Understand
        </button>
      </div>
    </div>
  </div>
 
  <div class="max-w-2xl mx-auto space-y-6">
    <h1 id="main-title"
      class="main-title-animate text-2xl md:text-3xl font-bold text-center 
             bg-gradient-to-r from-sky-400 via-blue-300 to-purple-400
             bg-clip-text text-transparent drop-shadow mb-1">
      üõ†Ô∏è Ren'Py RPY Translator
    </h1>
    <div class="bg-gray-800 rounded-xl p-4 space-y-4 shadow-lg">
      <div>
        <label class="block text-sm font-semibold mb-1">Translation Model</label>
        <select id="modelSelect" class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
          <option value="deepseek">DeepSeek (Paid API - Preserves Formatting)</option>
          <option value="libre">Lingva Translate (Free - Basic Translation)</option>
        </select>
      </div>
      <div id="apiKeyContainer">
        <label class="block text-sm font-semibold mb-1">DeepSeek API Key</label>
        <input id="apiKey" type="text" class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600" placeholder="Enter your API Key">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Target Language</label>
        <select id="langTarget" class="w-full px-3 py-2 rounded bg-gray-700 border border-gray-600">
          <option value="Bahasa Indonesia">Indonesian</option>
          <option value="English">English</option>
          <option value="Malay">Malay</option>
          <option value="Vietnamese">Vietnamese</option>
          <option value="Filipino">Filipino</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Upload .rpy File</label>
        <input id="fileInput" type="file" accept=".rpy" class="w-full">
      </div>
      <div>
        <progress id="progressBar" value="0" max="1000" class="w-full h-2"></progress>
        <div id="progressText" class="text-xs text-gray-400 text-right">0/0</div>
      </div>
      <div class="flex flex-col sm:flex-row gap-3">
        <button id="translateBtn" class="bg-blue-600 w-full py-2 rounded flex justify-center items-center gap-2 disabled:opacity-50">
          <span id="translateLabel">Start Translating</span>
          <span id="spinner" class="spinner hidden"></span>
        </button>
        <button id="downloadFinal" class="bg-green-600 w-full py-2 rounded">Download Result</button>
        <button id="downloadProgress" class="bg-yellow-600 w-full py-2 rounded">Download Log</button>
        <button id="previewBtn" class="bg-purple-600 w-full py-2 rounded disabled:opacity-50" disabled>Preview/Edit Manual</button>
      </div>
    </div>
    <div class="bg-gray-800 rounded-xl p-4 shadow-inner h-64 overflow-auto mb-0">
      <h2 class="text-sm font-semibold mb-2">Translation Log:</h2>
      <div id="logBox" class="text-xs font-mono space-y-1 h-56 overflow-auto"></div>
    </div>
    <div class="w-full -mt-3 mb-3">
      <div id="controlBtns" class="flex gap-2 justify-end" style="display:none;">
        <button id="stopBtn" class="bg-red-500 text-white rounded px-4 py-1">Stop Translation</button>
        <button id="resumeBtn" class="bg-green-500 text-white rounded px-4 py-1" disabled>Resume Translation</button>
      </div>
    </div>
  </div>
  <div class="max-w-2xl mx-auto mt-6">
    <a href="how-to-get-deepseek-api-key.html" 
   target="_blank" 
   rel="noopener noreferrer"
   class="block text-center text-blue-400 underline hover:text-blue-300 font-medium text-base transition mb-3">
  ‚ùì How to get a DeepSeek API Key?
</a>
<div class="flex justify-center mb-3">
  <a href="how-to-get-renpy-rpy.html" 
     target="_blank" 
     rel="noopener noreferrer"
     class="inline-flex items-center gap-2 px-5 py-2 bg-sky-800/90 border-2 border-sky-400 rounded-full shadow-lg hover:bg-sky-700 hover:border-sky-200 transition-all font-semibold text-base text-sky-100 ring-1 ring-sky-900/30 drop-shadow">
    <svg width="22" height="22" fill="none" viewBox="0 0 22 22" class="inline"><circle cx="11" cy="11" r="10" stroke="#38bdf8" stroke-width="2" fill="#1e293b"/><text x="11" y="16" text-anchor="middle" fill="#bae6fd" font-size="15" font-family="Arial" font-weight="bold">?</text></svg>
    How to get <span class="font-mono text-sky-200">.rpy</span> file from game?
  </a>
</div>
    <div id="watermark-place" class="flex justify-center mt-3"></div>
  </div>
 
  <div class="max-w-2xl mx-auto px-4 mt-2">
 
    <div class="text-center text-xs text-gray-400 mb-4">
      <p class="inline-flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>
          <span class="font-medium text-blue-300">Important:</span> DeepSeek requires an API key but provides higher quality translations that preserve Ren'Py formatting. Lingva is free but may require manual adjustments.
        </span>
      </p>
    </div>
  </div>
 
  <div class="max-w-2xl mx-auto mt-6 px-4 opacity-0 animate-fade-in" style="animation: fadeIn 1s ease-in-out forwards;">
  <div class="bg-gray-800/30 border border-gray-700 rounded-lg px-4 py-2 text-center backdrop-blur-sm">
    <p class="text-xs text-gray-300/90 flex items-center justify-center gap-1.5">
      <svg class="w-3 h-3 text-amber-400/80 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
      </svg>
      <span>By using this tool, you agree to accept all kinds of risks.</span>
    </p>
  </div>
  <div style="text-align: center; margin: 40px 0 20px;">
  <a href="../index.html" class="btn back-btn">‚¨ÖÔ∏è Back to Main Menu</a>
  </div>
</div>
 
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
 

<script>
/* Clean, deobfuscated translator script
   - Keeps UI and API behavior
   - No anti-debug / unauthorized checks
   - Supports DeepSeek (requires API key) and Lingva (public instance)
   - Sequential per-line translation with stop/resume, progress, and logs
*/

(async function(){
  // Utility helpers
  const $ = id => document.getElementById(id);
  const logBox = $('logBox');
  function appendLog(msg){
    const d = document.createElement('div');
    d.textContent = `${new Date().toISOString()} ${msg}`;
    d.className = 'text-xs';
    if(logBox) { logBox.appendChild(d); logBox.scrollTop = logBox.scrollHeight; }
  }
  function safeJSON(res){ try { return res.json(); } catch(e){ return null; } }

  // DOM refs
  const fileInput = $('fileInput');
  const translateBtn = $('translateBtn');
  const translateLabel = $('translateLabel');
  const progressBar = $('progressBar');
  const progressText = $('progressText');
  const downloadFinal = $('downloadFinal');
  const downloadProgress = $('downloadProgress');
  const previewBtn = $('previewBtn');
  const stopBtn = $('stopBtn');
  const resumeBtn = $('resumeBtn');
  const modelSelect = $('modelSelect');
  const apiKeyInput = $('apiKey');
  const langTarget = $('langTarget');

  let currentBlobURL = null;
  let stopped = false;
  let paused = false;
  let currentJob = null;

  // Default Lingva endpoint (public instance)
  const LINGVA_ENDPOINT = 'https://translate.icu/translate';

  // Simple Ren'Py line detection: capture quoted dialog lines "..." possibly preceded by identifier and space.
  function splitToTranslatableBlocks(text){
    // We'll split into array of objects: {type:'code'|'line', text: '...' }
    const lines = text.split(/\r?\n/);
    const out = [];
    const dialogRegex = /^\s*([a-zA-Z0-9_]+\s*)?\"(.*)\"\s*$/; // matches: mc "Hello"  or "Hello"
    for(const ln of lines){
      const m = ln.match(dialogRegex);
      if(m){
        // Keep the full original line but mark translatable content
        out.push({type:'line', orig: ln, content: m[2]});
      } else {
        out.push({type:'code', orig: ln});
      }
    }
    return out;
  }

  // Rebuild text from blocks (use translatedContents map)
  function rebuildText(blocks, translatedMap){
    return blocks.map((b, idx) => {
      if(b.type === 'line'){
        const translated = translatedMap[idx];
        if(translated != null){
          // Replace only the quoted content in the original line
          return b.orig.replace(/\"(.*)\"/, `"${translated}"`);
        } else return b.orig;
      } else return b.orig;
    }).join('\n');
  }

  // Translation functions
  async function translateWithLingva(text, target){
    // Lingva expects: POST with JSON {q, source, target} or GET? We'll use POST for reliability.
    try {
      const body = { q: text, source: 'en', target: target || 'vi' };
      const resp = await fetch(LINGVA_ENDPOINT, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!resp.ok) {
        const j = await safeJSON(resp);
        appendLog(`[Lingva] HTTP ${resp.status} ${resp.statusText} ${j?JSON.stringify(j):''}`);
        return null;
      }
      const j = await resp.json();
      // Different Lingva instances return different shapes; try common ones
      if(j && j.translatedText) return j.translatedText;
      if(j && j[0] && j[0].translation) return j[0].translation;
      // fallback: try to find first string in response
      if(typeof j === 'string') return j;
      if(Array.isArray(j) && j.length && j[0].length) return j[0][0];
      return null;
    } catch(err){
      appendLog(`[Lingva] network error: ${err.message}`);
      return null;
    }
  }

  async function translateWithDeepSeek(text, apiKey){
    const endpoint = 'https://api.deepseek.com/v1/chat/completions';
    try {
      const payload = {
        model: 'deepseek-chat',
        messages: [
          { role: 'system', content: 'Translate preserving Ren\\'Py formatting. Only translate the English dialogue inside quotes; keep all code and markup unchanged.' },
          { role: 'user', content: text }
        ],
        max_tokens: 2000
      };
      const resp = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'Authorization': apiKey ? ('Bearer ' + apiKey.trim()) : ''
        },
        body: JSON.stringify(payload)
      });
      if(resp.status === 401){
        appendLog('[DeepSeek] 401 Unauthorized - invalid API key');
        return { error: 'unauthorized' };
      }
      if(!resp.ok){
        const j = await safeJSON(resp);
        appendLog(`[DeepSeek] HTTP ${resp.status} ${resp.statusText} ${j?JSON.stringify(j):''}`);
        return null;
      }
      const j = await resp.json();
      // Try to parse common assistant/content shapes
      // e.g., { choices: [ { message: { content: "translated text" } } ] }
      if(j && j.choices && j.choices[0] && j.choices[0].message && j.choices[0].message.content){
        return j.choices[0].message.content.trim();
      }
      if(j && j.choices && j.choices[0] && j.choices[0].text){
        return j.choices[0].text.trim();
      }
      // fallback: stringify
      return typeof j === 'string' ? j : JSON.stringify(j);
    } catch(err){
      appendLog(`[DeepSeek] network error: ${err.message}`);
      return null;
    }
  }

  // Orchestrator: translate blocks sequentially
  async function runTranslation(fileText){
    stopped = false;
    paused = false;
    const blocks = splitToTranslatableBlocks(fileText);
    const totalLines = blocks.filter(b=>b.type==='line').length;
    progressBar.max = totalLines || 1;
    progressBar.value = 0;
    progressText.textContent = `0/${progressBar.max}`;

    const translatedMap = {};
    let translatedCount = 0;
    appendLog(`[START] Translating ${totalLines} dialogue lines.`);

    // iterate blocks by index so we can reconstruct easily
    for(let i=0;i<blocks.length;i++){
      if(stopped) { appendLog('[STOP] Translation cancelled by user.'); break; }
      // pause handling
      while(paused){
        await new Promise(r=>setTimeout(r,200));
        if(stopped) break;
      }
      const b = blocks[i];
      if(b.type !== 'line') continue;

      const original = b.content;
      let translated = null;
      const model = modelSelect.value;
      const target = (langTarget.value || 'Vietnamese').toLowerCase().startsWith('v') ? 'vi' : 'id';

      appendLog(`[LINE] ${original}`);

      if(model === 'deepseek'){
        const apiKey = apiKeyInput.value;
        const res = await translateWithDeepSeek(original, apiKey);
        if(res && res.error === 'unauthorized'){
          // fallback to lingva automatically
          appendLog('[NOTICE] DeepSeek unauthorized ‚Äî switching to Lingva for remaining lines.');
          modelSelect.value = 'libre';
          // continue to use Lingva for this line
          translated = await translateWithLingva(original, target);
        } else {
          translated = res;
        }
      } else {
        translated = await translateWithLingva(original, target);
      }

      if(translated == null){
        appendLog(`[WARN] Translation failed for line: ${original}`);
        // keep original to avoid leaving it blank
        translated = original;
      } else {
        // Clean translated to a single line and trim edges
        translated = String(translated).replace(/\r?\n/g,' ').trim();
      }

      translatedMap[i] = translated;
      translatedCount++;
      progressBar.value = translatedCount;
      progressText.textContent = `${translatedCount}/${progressBar.max}`;
      appendLog(`[OK] ${original} -> ${translated}`);
      // small delay to avoid rate limits
      await new Promise(r=>setTimeout(r, 250));
    }

    const final = rebuildText(blocks, translatedMap);
    appendLog('[COMPLETE] Translation finished.');
    // prepare download
    const blob = new Blob([final], {type:'text/plain;charset=utf-8'});
    if(currentBlobURL) URL.revokeObjectURL(currentBlobURL);
    currentBlobURL = URL.createObjectURL(blob);
    downloadFinal.href = currentBlobURL;
    downloadFinal.download = 'translated.rpy';
    // also prepare log download
    const logText = Array.from(logBox.children).map(n=>n.textContent).join('\n');
    const logBlob = new Blob([logText], {type:'text/plain;charset=utf-8'});
    const logUrl = URL.createObjectURL(logBlob);
    downloadProgress.href = logUrl;
    downloadProgress.download = 'translation_log.txt';
  }

  // Events
  translateBtn.addEventListener('click', async (e)=>{
    if(!fileInput.files || !fileInput.files[0]){
      alert('Please select a .rpy file first.');
      return;
    }
    translateBtn.disabled = true;
    translateLabel.textContent = 'Translating...';
    const f = fileInput.files[0];
    const txt = await f.text();
    currentJob = runTranslation(txt).finally(()=>{
      translateBtn.disabled = false;
      translateLabel.textContent = 'Start Translating';
    });
  });

  stopBtn.addEventListener('click', ()=>{ stopped = true; appendLog('[USER] Stop requested'); });
  resumeBtn.addEventListener('click', ()=>{ paused = false; appendLog('[USER] Resume requested'); });
  // Pause/resume via model buttons or UI could be added; demo keeps simple stop only.

  // Preview button - build current translated content if any (not editable in this simple version)
  previewBtn.addEventListener('click', ()=>{
    alert('Preview/Edit not implemented in this minimal rebuild. Please download result and edit locally.');
  });

  // Initialize UI defaults
  appendLog('Translator ready. Choose model and load a .rpy file.');
  // Show/hide API key depending on selection
  function updateApiKeyVisibility(){
    const v = modelSelect.value;
    const container = document.getElementById('apiKeyContainer');
    if(container) container.style.display = (v==='deepseek') ? 'block' : 'none';
  }
  modelSelect.addEventListener('change', updateApiKeyVisibility);
  updateApiKeyVisibility();

})();
</script>


</body>

</html>